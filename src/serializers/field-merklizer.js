import { DATA } from "../constants/constants.js";
import * as crypto from "../crypto/crypto.js";
import * as merkle from "../trees/merkle.js";
import * as uint8 from "../util/uint8.js";

// ============================================================================================================================ //
//  initialize()                                                                                                                //
// ============================================================================================================================ //
export function initialize(pepper) {
  let tree = merkle.newTree(),
      counter = 0;

  if(!pepper) {
    pepper = crypto.getRandomBytes(DATA.MERKLE_PEPPER_SIZE);
  }

  let shaker = getSaltShaker(pepper);

  return {
    pepper: pepper,

    // ------------------------------------------------------------------------------------------------------------------------ //
    //  add()                                                                                                                   //
    // ------------------------------------------------------------------------------------------------------------------------ //
    add: data => {
      let salt = shaker.getSalt(),
          leaf = uint8.from(salt, data),
          hash = tree.add(leaf);

      return [ counter++, hash, leaf ];
    },

    // ------------------------------------------------------------------------------------------------------------------------ //
    //  isEmpty()                                                                                                               //
    // ------------------------------------------------------------------------------------------------------------------------ //
    isEmpty: _ => !counter,

    // ------------------------------------------------------------------------------------------------------------------------ //
    //  generate()                                                                                                              //
    // ------------------------------------------------------------------------------------------------------------------------ //
    generate: _ => {
      return tree.generate();
    }
  };
}

// ============================================================================================================================ //
//  getProof()                                                                                                                  //
// ============================================================================================================================ //
export function getProof(treeData, indexList) {
  return merkle.buildProof(treeData, indexList);
}

// ============================================================================================================================ //
//  applyProof()                                                                                                                //
// ============================================================================================================================ //
export function applyProof(indexList, knownHash, proof) {
  return merkle.applyProof(indexList, knownHash, proof);
}

// ============================================================================================================================ //
//  getSaltShaker()                                                                                                             //
// ============================================================================================================================ //
function getSaltShaker(pepper) {
  let counter = 0,
      nextSalt;

  return {
    getSalt: _ => {
      if(counter++ & 1) {
        return nextSalt;
      }

      let salt = crypto.sha256AsBinary(uint8.from(pepper, counter >> 1));

      nextSalt = salt.slice(DATA.MERKLE_SALT_SIZE);
      return salt.slice(0, DATA.MERKLE_SALT_SIZE);
    }
  };
}
